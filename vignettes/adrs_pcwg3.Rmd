---
title: "Creating ADRS with Prostate Cancer Working Group 3 (PCWG3) Criteria"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating ADRS with Prostate Cancer Working Group 3 (PCWG3) Criteria}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(admiraldev)
library(gt)
```

# Introduction

This article describes creating an `ADRS` ADaM dataset for prostate cancer studies based on [**Prostate Cancer Working Group 3 (PCWG3)** criteria](https://ascopubs.org/doi/pdf/10.1200/JCO.2015.64.2702). Most of the endpoints are derived by calling `admiral::derive_extreme_event()`.

Metastatic prostate cancer response cannot be fully captured by RECIST 1.1 criteria alone. Therefore, the PCWG3 guidelines extend these criteria to include composite response combining RECIST 1.1 criteria on soft tissue lesions and PCWG3 rules on bone bone lesions.

Note that only the PCWG3-specific steps are covered in this vignette. For extended guidance on all steps in ADRS creation, refer to the examples in [Creating ADRS (Including Non-standard Endpoints)](adrs.html).

## Required Packages

The examples of this vignette require the following packages.

```{r, warning=FALSE, message=FALSE}
library(admiral)
library(admiralonco)
library(pharmaversesdtm)
library(pharmaverseadam)
library(dplyr)
library(tibble)
```

# PCWG3 Guidelines for Prostate Cancer Progression

In metastatic prostate cancer clinical trials, efficacy is assessed using PCWG3-modified RECIST 1.1 response, PSA tumor marker results, and bone lesion assessments. Bone lesions are particularly critical for evaluating progressive disease (PD) using 2+2 rule.

## PSA Exclusion
Prostate-specific antigen (PSA) tumor marker assessments are a key component of the PCWG3 criteria for evaluating prostate cancer progression. However, they are excluded in this vignette to focus solely on deriving PCWG3-modified RECIST 1.1 endpoints related to soft tissue and bone lesions.


## Response Categories Based on PCWG3 Guidelines:

In this vignette, we have not included RECIST 1.1 responses (soft tissue responses), as they are well-documented and widely known, and have focused solely on PCWG3 guidelines for evaluating bone scan responses in prostate cancer. PCWG3 provides specific criteria for assessing bone lesions, including categories like PDu, NED, and PD, along with the 2+2 rule for confirming progression.

### Progressive Disease Unconfirmed (PDu)
- At least 2 new bone lesions have appeared _within the flare window_ compared to baseline _or_
- At least 2 new bone lesions have appeared _outside the flare window_ compared to the first post-treatment scan.

Note: if there is no following visit (final visit), the time point remains at PDu.

### Progressive Disease (PD)  
- At least 2 new bone lesions had appeared _within the flare window_ compared to
baseline (PDu), and at least 2 additional new bone lesions have been found on
the next scan confirming progression (PD). The date of progression is the date
of the scan showing the first 2 lesions. _Or_
- At least 2 new bone lesions had appeared _outside the flare window_ compared
to the first post-treatment scan (PDu), and the 2 lesions are persistent on the
next scan confirming progression (PD). The date of progression is the data of
the scan that first documents the second lesion.

See [**Bone Lesion Confirmation Guidance (The 2+2 Rule)**](#22rule) for further details.

### Not Evaluable (NE)  
When imaging is entirely missing or was not done, but bone lesions were present at baseline.
  
### No Evidence of Disease (NED)
No bone lesions are present on the scan (whether some were present at baseline and have completely
disappeared or whether there were no bone lesions from the start).

### Non-Progressive Disease (Non-PD)
Neither PD, PDu, NED or NE.

### Bone Lesion Confirmation Guidance (The 2+2 Flare Rule){#22rule}

**Progression on a Bone Scan:**

Please note: The flare period is generally considered to be the first 8â€“12 weeks post-baseline, primarily involving the initial post-baseline assessment. Please refer to your study documentation to confirm how the flare period is defined.

**Flare Period: Bone Scan Progression Criteria for the First Post-Baseline Scan:**
If two or more new bone lesions are identified at the first post-baseline assessment compared to the baseline scan, and then at the second assessment (conducted at least 6 weeks later), two or more additional new lesions are observed (resulting in a cumulative total of four or more new lesions since the baseline scan), the progression date is set as the date of the initial scan. This process is referred to as the "2+2 rule."

**After Flare Period: If No Progression is Detected at the First Assessment:**
The initial post-baseline scan becomes the new reference point for subsequent scans.
If two or more new lesions appear relative to this new baseline, and their persistence or increase in number is confirmed by a follow-up scan at least 6 weeks later, the progression date is recorded as the date of the first scan that noted the appearance of the two new lesions.

#### Examples of the 2+2 Rule

**Flare Period Progression**  
A patient with metastatic prostate cancer has a baseline bone scan showing 10 lesions. At the first post-baseline scan (within the flare period), 2 new lesions are identified, increasing the total count to 12. This finding is labeled as Progressive Disease Unconfirmed (PDu). A follow-up scan conducted at least 6 weeks later reveals 2 additional new lesions (totaling 4 new lesions compared to baseline). Progression is confirmed based on the 2+2 rule, and the progression date is set as the date of the first post-baseline scan.

**Flare Phenomenon**  
In another scenario, the same patient has a baseline bone scan showing 10 lesions. The first post-baseline scan during the flare period identifies 2 new lesions, increasing the count to 12. However, a follow-up scan conducted 6 weeks later reveals no additional new lesions. According to the 2+2 rule, this is classified as a flare phenomenon, not true progression.

**After Flare Period Progression**  
A patient has a baseline scan showing 8 lesions. The initial post-baseline scan, conducted 12 weeks after baseline (outside the flare period), shows no new lesions, meaning progression is not detected. This scan becomes the new reference point for subsequent assessments.

At a later scan conducted 6 weeks after the new reference point (18 weeks post-baseline), 2 new lesions are observed relative to the new reference point. A follow-up scan performed 6 weeks later (24 weeks post-baseline) confirms the persistence of the 2 new lesions.

Progression is confirmed based on persistence of 2 new lesions, and the progression date is recorded as the date of the first scan noting the 2 new lesions (18 weeks post-baseline).

Please check [Responses & Bone Lesion Confirmation Guidance (The 2+2 Flare Rule)](https://4870646.fs1.hubspotusercontent-na1.net/hubfs/4870646/KEO149_Info_PCWG3_03.2.pdf) for more details.


# Programming Workflow
  
-   [Read in Data](#readdata)
-   [Pre-processing of Input Records](#input)
-   [Derive Best Overall Response (BOR)](#bor)
-   [Derive Confirmed Best Overall Response (CBOR)](#cbor)
-   [Other Endpoints](#other)
            
              
## Read in Data {#readdata}

To begin, all data frames needed for the creation of `ADRS` should be read into the environment. This will be a company specific process. Some of the data frames needed are `ADSL` and `RS`.
            
For demonstration purpose, the SDTM and ADaM datasets (based on CDISC Pilot test data) from `{pharmaversesdtm}` and `{pharmaverseadam}` are used.
              
In this vignette, the `RS` SDTM dataset is expected to contain:

- Soft tissue lesion responses evaluated using RECIST 1.1 criteria at each timepoint.
- Bone lesion responses assessed across visits using PCWG3 rules.
- Combined responses derived from both RECIST 1.1 (soft tissue) and PCWG3 (bone lesion) guidelines as collected at source.

It is assumed that all datasets used in the example have been preprocessed and are "ready for analysis".
            
```{r message=FALSE}
# PCWG3 SDTM data
rs <- pharmaversesdtm::rs_onco_pcwg3
rs <- convert_blanks_to_na(rs)

# Exclude PSA records
rs <- rs %>% filter(RSTEST != "Tumor Marker Response")

# ADaM data
adsl <- pharmaverseadam::adsl
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  rs,
  display_vars = exprs(USUBJID, RSCAT, RSTESTCD, RSSTRESC, VISIT, VISITNUM, RSDTC)
)
```

## Pre-processing of Input Records {#input}
At this step, it may be useful to join `ADSL` to your `RS` domain. Only the `ADSL` variables used for derivations are selected 
at this step.

```{r eval=TRUE}
adsl_vars <- exprs(TRTSDT)
adrs <- derive_vars_merged(
  rs,
  dataset_add = adsl,
  new_vars = adsl_vars,
  by_vars = get_admiral_option("subject_keys")
)
```

### Partial Date Imputation and Deriving `ADT`, `ADTF`, `AVISIT`, `AVISITN` etc.

If your data collection allows for partial dates, you could apply a company-specific imputation rule at this stage when deriving `ADT`. For this example, here we impute missing day to last possible date.

```{r}
adrs <- adrs %>%
  derive_vars_dtm(
    dtc = RSDTC,
    new_vars_prefix = "A",
    highest_imputation = "D",
    date_imputation = "last"
  ) %>%
  derive_vars_dtm_to_dt(exprs(ADTM)) %>%
  derive_vars_dy(
    reference_date = TRTSDT,
    source_vars = exprs(ADT)
  ) %>%
  mutate(
    AVISIT = VISIT,
    AVISITN = VISITNUM
  )
```

### Derive `PARAMCD`, `PARAM`, `PARAMN`

The next step is to assign parameter level values such as `PARAMCD`, `PARAM`, `PARAMN` to values collected from source, etc. 
For this, a lookup can be created based on the SDTM `RSTESTCD` values.

```{r, eval=TRUE, include=TRUE, message=FALSE}
# Prepare param_lookup for SDTM RSTESTCD to add metadata
param_lookup <- tibble::tribble(
  ~RSTESTCD,  ~PARAMCD,   ~PARAM,                                   ~PARAMN,
  "SFTSRESP", "SFTSRESP", "Soft Tissue Response by Investigator",         1,
  "BONERESP", "BONERESP", "Bone Response by Investigator",                2,
  "OVRLRESP", "OVRLRESP", "Overall Tumor Response by Investigator",       3
)

adrs <- adrs %>%
  left_join(param_lookup, by = "RSTESTCD") %>%
  mutate(
    PARCAT1 = RSCAT,
    AVALC = RSSTRESC
  )
```

## Derive Combined Overall Time Point Response by Investigator (`OVRLRESC`) Parameter

Although `OVRLRESP`, representing the Overall Tumor Response by Investigator is available in the source data, we have re-derived the combined overall response by Investigator (`OVRLRESC`). This derivation follows the rules from the **PCWG3 and RECIST 1.1 combined response interpretation**, as described in the PharmaSUG 2024 publication on metastatic prostate cancer response criteria ([PharmaSUG 2024, DS-287](https://www.lexjansen.com/pharmasug/2024/DS/PharmaSUG-2024-DS-287.pdf)).

### Table : Combined Overall Time Point Response as per summarized PCWG3 guidelines

```{r, eval=TRUE, include=TRUE, message=FALSE,echo=FALSE}
overall_tpr_table <- tribble(
  ~`Soft Tissue (RECIST 1.1) TPR`, ~`Bone Lesion (PCWG3) TPR`, ~`Overall PCWG TPR`,
  "PD", "Any", "PD",
  "Any", "PD", "PD",
  "NE", "Non-PD, PDu, NED or NE", "NE",
  "NED", "Non-PD", "Non-CR/Non-PD",
  "NED", "PDu", "PDu",
  "NED", "NED", "NE",
  "NED", "NE", "NE",
  "SD", "Non-PD, PDu, NED or NE", "SD",
  "Non-CR/Non-PD", "Non-PD, PDu, NED or NE", "Non-CR/Non-PD",
  "PR", "Non-PD, PDu, NED or NE", "PR",
  "CR", "Non-PD, PDu, or NE", "PR (1)",
  "CR", "Non-PD, PDu, or NE", "Non-CR/Non-PD (2)",
  "CR", "NED", "CR"
)

overall_tpr_table %>%
  gt() %>%
  tab_header(
    title = "Table 1: Overall Time Point Response",
    subtitle = "Soft Tissue (RECIST 1.1) TPR, Bone Lesion (PCWG3) TPR, and PCWG Combined TPR"
  ) %>%
  cols_label(
    `Soft Tissue (RECIST 1.1) TPR` = "Soft Tissue (RECIST 1.1)",
    `Bone Lesion (PCWG3) TPR` = "Bone Lesion (PCWG3)",
    `Overall PCWG TPR` = "Overall PCWG"
  ) %>%
  tab_footnote(
    footnote = "* When no target and non-target lesions are identified at baseline, and no new lesions are identified on-study, the response will be No Evidence of Disease (NED)."
  ) %>%
  tab_footnote(
    footnote = "** Progressive Disease Unconfirmed (PDu): Temporary marker of possible PD where at least 2 new bone lesions are present, but an additional scan is required for confirmation."
  ) %>%
  tab_footnote(
    footnote = "(1) The overall TPR will be PR if target lesions were present at screening."
  ) %>%
  tab_footnote(
    footnote = "(2) The overall TPR will be Non-CR/Non-PD if no target lesions were present at screening."
  )
```

Note:`Non-PD` is changed to `NON-PD` at programming level to match with data
 
Note: For Scenario 11, in this vignette, it is assumed that all subjects have target lesions identified at screening/baseline. If non-target lesions are also classified in the data, the overall response must be evaluated differently, as described in Scenario 11 and referenced in the commented code. Please review your study data to verify whether lesions are categorized as target or non-target, as this classification impacts the derivation of the overall response.

```{r, eval=TRUE, include=TRUE, message=FALSE}
adrs <- derive_param_computed(
  dataset = adrs,
  by_vars = exprs(USUBJID, VISIT, ADT, ADTF, AVISIT, AVISITN),
  parameters = c("SFTSRESP", "BONERESP"),
  set_values_to = exprs(
    AVALC = case_when(

      # Scenario 1 & 2: Soft Tissue PD or Bone Lesion PD -> Overall response = PD
      AVALC.SFTSRESP == "PD" | AVALC.BONERESP == "PD" ~ "PD",

      # Scenario 3: Soft Tissue = NE + Bone Lesion = NON-PD, PDu, NED, or NE -> Overall response = NE
      AVALC.SFTSRESP == "NE" & AVALC.BONERESP %in% c("NON-PD", "PDu", "NED", "NE") ~ "NE",

      # Scenario 4: Soft Tissue = NED + Bone Lesion = NON-PD -> Overall response = Non-CR/NON-PD
      AVALC.SFTSRESP == "NED" & AVALC.BONERESP == "NON-PD" ~ "Non-CR/NON-PD",

      # Scenario 5: Soft Tissue = NED + Bone Lesion = PDu -> Overall response = PDu
      AVALC.SFTSRESP == "NED" & AVALC.BONERESP == "PDu" ~ "PDu",

      # Scenario 6: Soft Tissue = NED + Bone Lesion = NED -> Overall response = NE
      AVALC.SFTSRESP == "NED" & AVALC.BONERESP == "NED" ~ "NE",

      # Scenario 7: Soft Tissue = NED + Bone Lesion = NE -> Overall response = NE
      AVALC.SFTSRESP == "NED" & AVALC.BONERESP == "NE" ~ "NE",

      # Scenario 8: Soft Tissue = SD + Bone Lesion = NON-PD, PDu, NED, or NE -> Overall response = SD
      AVALC.SFTSRESP == "SD" & AVALC.BONERESP %in% c("NON-PD", "PDu", "NED", "NE") ~ "SD",

      # Scenario 9: Soft Tissue = Non-CR/NON-PD + Bone Lesion = NON-PD, PDu, NED, or NE -> Overall response = Non-CR/NON-PD
      AVALC.SFTSRESP == "Non-CR/NON-PD" & AVALC.BONERESP %in% c("NON-PD", "PDu", "NED", "NE") ~ "Non-CR/NON-PD",

      # Scenario 10: Soft Tissue = PR + Bone Lesion = NON-PD, PDu, NED, or NE -> Overall response = PR
      AVALC.SFTSRESP == "PR" & AVALC.BONERESP %in% c("NON-PD", "PDu", "NED", "NE") ~ "PR",

      # Scenario 11: Soft Tissue = CR + Bone Lesion = NON-PD, PDu, NE -> Overall response = PR
      # ((1) The overall TPR will be PR if target lesions were present at screening.)
      AVALC.SFTSRESP == "CR" & AVALC.BONERESP %in% c("NON-PD", "PDu", "NE") ~ "PR",

      # Soft Tissue = CR + Bone Lesion = NON-PD, PDu, NE -> Overall response =Non-CR/NON-PD
      # (2) The overall TPR will be Non-CR/NON-PD if no target lesions were present at screening.)
      # AVALC.SFTSRESP == "CR" & AVALC.BONERESP %in% c("NON-PD", "PDu", "NE") ~ "Non-CR/NON-PD",

      # Scenario 12: Soft Tissue = CR + Bone Lesion = NED -> Overall response = CR
      AVALC.SFTSRESP == "CR" & AVALC.BONERESP == "NED" ~ "CR",

      # Default: If conditions are not met, assign NA
      TRUE ~ NA_character_
    ),
    PARAMCD = "OVRLRESC",
    PARAM = "Overall Tumor Response by Investigator - Derived",
    PARAMN = 4,
    PARCAT1 = "PCWG3 and RECIST 1.1"
  )
)
``` 


```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = exprs(USUBJID, PARAM, PARAMCD, PARCAT1, AVALC, AVISIT, ADT)
)
```


## Derive `AVAL` (Numeric tumor response from `AVALC` values)

```{r}
adrs <- adrs %>%
  mutate(
    AVAL = case_when(
      AVALC == "CR" ~ 1, # Complete Response
      AVALC == "PR" ~ 2, # Partial Response
      AVALC == "SD" ~ 3, # Stable Disease
      AVALC == "PD" ~ 4, # Progressive Disease
      AVALC == "Non-CR/NON-PD" ~ 5, # Neither Complete Response nor Progressive Disease
      AVALC == "NON-PD" ~ 6, # Non-Progressive Disease
      AVALC == "PDu" ~ 7, # Progressive Disease Unconfirmed
      AVALC == "NE" ~ 8, # Not Evaluable
      AVALC == "NED" ~ 9, # No Evidence of Disease
      TRUE ~ NA_real_ # Default for unexpected/missing AVALC values
    )
  )
```

```{r, echo=FALSE}
dataset_vignette(
  adrs %>%
    arrange(!!!get_admiral_option("subject_keys"), AVISITN, PARAMN, ),
  display_vars = exprs(USUBJID, PARCAT1, PARAMCD, PARAM, PARAMN, AVISIT, AVISITN, ADT, AVALC, AVAL)
)
```

### Create last assessment flag for OVRLRESC for dealing with last recorded assessment `Pdu`
```{r}
adrs <- adrs %>%
  restrict_derivation(
    derivation = derive_var_extreme_flag,
    args = params(
      by_vars = exprs(USUBJID), # Group records by Subject ID
      order = exprs(ADT), # Sort records by Assessment Date
      new_var = LAST_REC_FL, # Name of the derived flag for last record
      mode = "last" # Flag only the last record per group
    ),
    filter = PARAMCD == "OVRLRESC" # Restriction: Derive flag only for OVRLRESC records
  )
```

```{r, echo=FALSE}
dataset_vignette(
  adrs %>%
    filter(PARAMCD == "OVRLRESC" & LAST_REC_FL == "Y"),
  display_vars = exprs(USUBJID, PARAMCD, AVISIT, AVISITN, ADT, AVALC, AVAL, LAST_REC_FL)
)
```

## Best Overall Response (BOR) and Confirmed Best Overall Response (CBOR)

BOR represents the Best Overall Responses observed during the study, reflecting valid tumor responses such as Complete Response (CR), Partial Response (PR), Stable Disease (SD), and Progressive Disease (PD). 

CBOR, on the other hand, refers to the Confirmed Best Overall Response, requiring sustained responses like CR and PR to meet confirmation criteria, such as persistence over a predefined confirmation period (e.g., 28 days), based on PCWG3 guidelines.

For both BOR and CBOR, *Progressive Disease Unconfirmed (PDu)* transitions to **PD** if confirmed as progression using the 2+2 rule. If **PDu remains the last recorded assessment** without follow-up confirmation, it is classified as **SD** in this vignette. However, as a more conservative approach, you may choose to classify it as **PD**. Please refer to your study documentation and protocol requirements to confirm the preferred approach to handling unresolved PDu.

```{r}
pdu_to_sd_event <- event(
  description = "Transition PDu to SD if it is the last unresolved assessment",
  dataset_name = "adrs",
  condition = PARAMCD == "OVRLRESC" & AVALC == "PDu" & LAST_REC_FL == "Y", # PDu â†’ SD
  set_values_to = exprs(AVALC = "SD")
)

pdu_to_pd_event <- event_joined(
  description = "Transition PDu to PD if progression is confirmed by subsequent PD",
  dataset_name = "adrs",
  join_vars = exprs(AVALC, ADT),
  join_type = "after", # Look at subsequent assessments after current record
  first_cond_upper = AVALC.join == "PD" & ADT.join > ADT, # Next record confirms PD with later date
  condition = PARAMCD == "OVRLRESC" & AVALC == "PDu", # Current record is PDu
  set_values_to = exprs(AVALC = "PD") # Transition PDu â†’ PD
)
```

```{r, eval=TRUE, include=TRUE, message=FALSE}
# Define events for Best Overall Response (BOR)
bor_cr <- event(
  description = "Complete Response (CR) ",
  dataset_name = "adrs",
  condition = AVALC == "CR",
  set_values_to = exprs(AVALC = "CR")
)

bor_pr <- event(
  description = "Partial Response (PR) ",
  dataset_name = "adrs",
  condition = AVALC == "PR",
  set_values_to = exprs(AVALC = "PR")
)

bor_non_cr_non_pd <- event(
  description = "Non-CR/Non-PD ",
  dataset_name = "adrs",
  condition = AVALC == "Non-CR/Non-PD",
  set_values_to = exprs(AVALC = "Non-CR/Non-PD")
)

bor_sd <- event(
  description = "Stable Disease (SD) ",
  dataset_name = "adrs",
  condition = AVALC == "SD",
  set_values_to = exprs(AVALC = "SD")
)

bor_pd <- event(
  description = "Progressive Disease (PD) ",
  dataset_name = "adrs",
  condition = AVALC == "PD",
  set_values_to = exprs(AVALC = "PD")
)

bor_ne <- event(
  description = "Not Evaluable (NE) ",
  dataset_name = "adrs",
  condition = AVALC == "NE",
  set_values_to = exprs(AVALC = "NE")
)

no_assessment_event <- event(
  description = "No assessment data available for subject",
  dataset_name = "adrs",
  condition = is.na(AVALC), # Condition where AVALC is missing
  set_values_to = exprs(AVALC = "NE") # Assign default value as NE
)
```


## Derive Best Overall Response (BOR){#bor}

Use the defined events to derive BOR based on the first occurrence in the `adrs`
dataset, prioritizing responses hierarchically (CR > PR > SD > PD > NE).

In this part of the vignette, we will derive Best Overall Response based on combined response 
(`PARAMCD = "OVRLRESC"`) as derived above.

```{r, eval=TRUE, include=TRUE, message=FALSE} 
# Derive BOR
adrs <- adrs %>%
  derive_extreme_event(
    by_vars = exprs(USUBJID),
    events = list(bor_cr, bor_pr, bor_sd, pdu_to_sd_event, bor_pd, pdu_to_pd_event, bor_ne, no_assessment_event), # Hierarchical order
    source_datasets = list(adrs = adrs %>% filter(PARAMCD == "OVRLRESC")), # Use derived responses (OVRLRESC)
    order = exprs(event_nr, ADT), # Prioritize earliest valid event
    tmp_event_nr_var = event_nr,
    mode = "first", # Retain the best response observed at the first occurrence
    set_values_to = exprs(
      PARAMCD = "BOR",
      PARAM = "Best Overall Response",
      PARAMN = 5
    )
  )
```


```{r, echo=FALSE}
dataset_vignette(
  adrs %>%
    filter(PARAMCD == "BOR"),
  display_vars = exprs(USUBJID, PARAM, PARAMCD, AVISIT, AVISITN, ADT, AVALC, AVAL)
)
```

## Derive Confirmed BOR (CBOR){#cbor}

As per RECIST 1.1 and PCWG3 guidelines, Complete Response (CR) and Partial Response (PR) require confirmation within a **28-day period** to ensure their validity.

```{r, eval=TRUE, include=TRUE, message=FALSE}
# Confirmed CR Event with 28-day persistence
cbor_cr <- event_joined(
  description = "Confirmed Complete Response (CR)",
  dataset_name = "adrs",
  join_vars = exprs(AVALC, ADT),
  join_type = "after",
  first_cond_upper = AVALC.join == "CR" & ADT.join >= ADT + 28, # Follow-up within 28-day window
  condition = AVALC == "CR" & all(AVALC.join == "CR"), # All linked records must also be CR
  set_values_to = exprs(AVALC = "CR") # Set response as Confirmed CR
)

# Confirmed PR Event with 28-day persistence
cbor_pr <- event_joined(
  description = "Confirmed Partial Response (PR)",
  dataset_name = "adrs",
  join_vars = exprs(AVALC, ADT),
  join_type = "after",
  first_cond_upper = AVALC.join %in% c("CR", "PR") & ADT.join >= ADT + 28, # Include CR as confirmation
  condition = AVALC == "PR" & all(AVALC.join %in% c("CR", "PR")), # Ensure all events align
  set_values_to = exprs(AVALC = "PR")
)
```  


```{r, eval=TRUE, include=TRUE, message=FALSE}
adrs <- adrs %>%
  derive_extreme_event(
    by_vars = exprs(USUBJID),
    events = list(cbor_cr, cbor_pr, bor_non_cr_non_pd, bor_sd, pdu_to_sd_event, bor_pd, pdu_to_pd_event, bor_ne, no_assessment_event),
    source_datasets = list(adrs = adrs %>% filter(PARAMCD == "OVRLRESC")),
    tmp_event_nr_var = event_nr,
    order = exprs(event_nr, ADT),
    mode = "first",
    set_values_to = exprs(
      PARAMCD = "CBOR",
      PARAM = "Confirmed Best Overall Response",
      PARAMN = 6
    )
  )
```

```{r, echo=FALSE}
dataset_vignette(
  adrs %>%
    filter(PARAMCD == "CBOR"),
  display_vars = exprs(USUBJID, PARAM, PARAMCD, AVISIT, AVISITN, ADT, AVALC, AVAL)
)
```

# Other Endpoints {#other}

For examples on the additional endpoints, please see [Creating ADRS (Including Non-standard Endpoints)](adrs.html).
