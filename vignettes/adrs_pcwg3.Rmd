---
title: "Creating ADRS Using Prostate Cancer Working Group 3 (PCWG3) Guidelines"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating ADRS with Prostate Cancer Working Group 3 (PCWG3) Criteria}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(admiraldev)
library(dplyr)
library(tibble)
library(gt)

```
# Introduction

This article describes creating an `ADRS` ADaM dataset for prostate cancer studies based on [**Prostate Cancer Working Group 3 (PCWG3)** criteria](https://ascopubs.org/doi/pdf/10.1200/JCO.2015.64.2702).

Metastatic prostate cancer progression often includes measurements not fully captured by RECIST 1.1 criteria alone. Therefore, the PCWG3 guidelines extend these criteria to include composite measures combining RECIST 1.1 and PCWG3 rules.

Note that only the PCWG3-specific steps are covered in this vignette. For extended guidance on all steps in ADRS creation, refer to the examples in [Creating ADRS (Including Non-standard Endpoints)](adrs.html).


## PCWG3 Guidelines for Prostate Cancer Progression

In metastatic prostate cancer, disease progression is tracked using soft tissue lesion responses (RECIST 1.1), 
PSA tumor marker results, and bone lesion assessments (PCWG3).

**Response Categories Based on PCWG3 Guidelines Ordering From Best to Worst:"NED > CR > PR > SD > PDu > PD > NE"** 


### 1.**No Evidence of Disease (NED)**
     - No measurable lesions detected at baseline and no new lesions identified during the study.  
     - No target or non-target lesions recorded in screening.  
     - No new lesions observed on-study.
  
### 2. **Complete Response (CR)**  
     - Disappearance of all known lesions (soft tissue and bone).  
     - PSA normalized. 
     - No new lesions.

### 3. **Partial Response (PR)**  
     - ≥30% reduction in soft tissue target lesion size.  
     - ≥50% PSA decline from baseline.  

### 4. **Stable Disease (SD)**  
     - Insufficient regression for CR/PR and no sufficient progression for PD.  

### 5. **Progressive Disease Unconfirmed (PDu)**  
     - Temporary status indicating suspected progression requiring follow-up confirmation.  
     - Appearance of ≥2 new bone lesions.  
     - Progression confirmed only with ≥2 additional new lesions on subsequent imaging ("2+2 flare rule").

### 6. **Progressive Disease (PD)**  
     - Appearance of ≥2 new lesions confirmed on subsequent imaging (`2+2 flare rule`).  
     - PSA increase ≥25% from nadir with ≥2 ng/mL absolute increase.  

### 7. **Not Evaluable (NE)**  
     - Insufficient or missing data prevents evaluation.
  


This ordering reflects both RECIST 1.1 and PCWG3 priority interpretations for clinical analysis and 
this vignette demonstrates how to derive key analysis-ready parameters from response criteria.

# Required Packages

The examples of this vignette require the following packages.

```{r, warning=FALSE, message=FALSE}
library(admiral)
library(admiralonco)
library(pharmaversesdtm)
library(pharmaverseadam)
```


# Programming Workflow
  
-   [Read in Data](#readdata)
-   [Pre-processing of Input Records](#input)
-   [Soft Tissue and Bone Lesion Responses](#assessments)
-   [Bone Lesion Confirmation Guidance  (`2+2 Flare Rule`)](#boneconfirmationguidance)
-   [Derive Best Overall Response (BOR)](#bor)
-   [Derive Confirmed Best Overall Response (CBOR)](#cbor)
            
              
## Read in Data {#readdata}

To start, all data frames needed for the creation of `ADRS` should be read into the environment. This will be a company specific process. Some of the data frames needed are `ADSL` and `RS`.
            
For demonstration purpose, the SDTM and ADaM datasets (based on CDISC Pilot test data)---which are included in `{pharmaversesdtm}` and `{pharmaverseadam}`---are used.
              
In this vignette, the **RS SDTM dataset** is expected to contain:
- Soft tissue lesion responses evaluated using RECIST 1.1 criteria at each timepoint.  
- Bone lesion responses based on PCWG3 rules, assessed across visits.  
- Combined responses derived from RECIST 1.1 and PCWG3 guidelines. 

It is assumed that these datasets are **preprocessed and ready for analysis**.
            
```{r message=FALSE}

# PCWG3 SDTM data
rs <- pharmaversesdtm::rs_onco_pcwg3
rs <- convert_blanks_to_na(rs)

# ADaM data
adsl <- pharmaverseadam::adsl


```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  rs,
   display_vars = exprs(USUBJID,RSCAT,RSTESTCD,RSSTRESC,VISIT,VISITNUM,RSDTC)
)
```

## Pre-processing of Input Records {#input}
At this step, it may be useful to join `ADSL` to your `RS` domain. Only the `ADSL` variables used for derivations are selected 
at this step.

```{r eval=TRUE}
adsl_vars <- exprs(RANDDT, TRTSDT)
adrs <- derive_vars_merged(
  rs,
  dataset_add = adsl,
  new_vars = adsl_vars,
  by_vars = get_admiral_option("subject_keys")
)
```

### Partial Date Imputation and Deriving `ADT`, `ADTF`, `AVISIT`, `AVISITN` etc.

If your data collection allows for partial dates, you could apply a company-specific imputation rule at this stage when deriving `ADT`. For this example, here we impute missing day to last possible date.

```{r}
adrs <- adrs %>%
   derive_vars_dtm(
    dtc = RSDTC,
    new_vars_prefix = "A",
    highest_imputation = "D",
    date_imputation = "last"
  ) %>%
  derive_vars_dtm_to_dt(exprs(ADTM)) %>%
  derive_vars_dy(
    reference_date = TRTSDT,
    source_vars = exprs(ADT)
  )  %>%
  mutate(AVISIT = VISIT,
         AVISITN=VISITNUM)
```

## Soft Tissue and Bone Lesion Responses

The next step is to assign parameter level values such as `PARAMCD`,`PARAM`,`PARAMN` to values collected from source, etc. 
For this, a lookup can be created based on the SDTM RSTESTCD values..

```{r, eval=TRUE, include=TRUE, message=FALSE, echo=FALSE}

# Prepare param_lookup for SDTM RSTESTCD to add metadata
param_lookup <- tibble::tribble(
  ~RSTESTCD,   ~PARAMCD,   ~PARAM,                            ~PARAMN,
  "TMRESP",   "TMRESP",   "Tumor Marker Response by Investigator",  1,
  "SFTSRESP", "SFTSRESP", "Soft Tissue Response by Investigator",   2,
  "BONERESP", "BONERESP", "Bone Response by Investigator",          3,
  "OVRLRESP", "OVRLRESP", "Overall Tumor Response by Investigator", 4,
)


adrs <- adrs %>%
  left_join(param_lookup, by = "RSTESTCD") %>% 
  mutate(
    PARCAT1=RSCAT,
    AVALC = RSSTRESC)
```


Although `OVRLRESP`, representing the Overall Tumor Response by Investigator is available in the source data, we have re-derived the Combined overall response by Investigator (`OVRLRESC`) based on **Prostate Cancer Working Group 3 (PCWG3) guidelines**. This derivation follows the summarization rules from the **PCWG3 and RECIST 1.1 combined response interpretation**, as described in the PharmaSUG 2024 publication on metastatic prostate cancer response criteria ([PharmaSUG 2024, DS-287](https://www.lexjansen.com/pharmasug/2024/DS/PharmaSUG-2024-DS-287.pdf)).


#### Table : Overall Time Point Response as per summarized (PCWG3) guidelines

```{r, eval=TRUE, include=TRUE, message=FALSE}


overall_tpr_table <- tribble(
  ~`Soft Tissue (RECIST 1.1) TPR`, ~`Bone Lesion (PCWG3) TPR`, ~`Overall PCWG TPR`,
  "PD", "Any", "PD",
  "Any", "PD", "PD",
  "NE", "Non-PD, PDu, NED, or NE", "NE",
  "NED", "Non-PD", "Non-CR/Non-PD",
  "NED", "PDu", "PDu",
  "NED", "NED", "NE",
  "NED", "NE", "NE",
  "SD", "Non-PD, PDu, NED, or NE", "SD",
  "Non-CR/Non-PD", "Non-PD, PDu, NED, or NE", "Non-CR/Non-PD",
  "PR", "Non-PD, PDu, NED, or NE", "PR",
  "CR", "Non-PD, PDu, or NE", "PR (1)",
  "CR", "NED", "CR"
)

# Render Colorful Table with Fixed Footnotes
overall_tpr_table %>%
  gt() %>%
  tab_header(
    title = "Table 1: Overall Time Point Response",
    subtitle = "Soft Tissue (RECIST 1.1) TPR, Bone Lesion (PCWG3) TPR, and PCWG Combined TPR"
  ) %>%
  cols_label(
    `Soft Tissue (RECIST 1.1) TPR` = "Soft Tissue (RECIST 1.1)",
    `Bone Lesion (PCWG3) TPR` = "Bone Lesion (PCWG3)",
    `Overall PCWG TPR` = "Overall PCWG"
  ) %>%
  tab_footnote(
    footnote = "When no target and non-target lesions are identified at baseline, and no new lesions are identified on-study, the response will be No Evidence of Disease (NED).",
    locations = cells_column_labels(columns = `Overall PCWG TPR`)  # Correct column name
  ) %>%
  tab_footnote(
    footnote = "Progressive Disease Unconfirmed (PDu): Temporary marker of possible PD where at least 2 new bone lesions are present, but an additional scan is required for confirmation.",
    locations = cells_column_labels(columns = `Bone Lesion (PCWG3) TPR`)  # Correct column name
  ) %>%
  tab_footnote(
    footnote = "(1) The overall TPR will be PR if target lesions were present at screening.",
    locations = cells_body(columns = `Overall PCWG TPR`, rows = 11)  # Correct column name
  ) %>%
  tab_footnote(
    footnote = "(2) The overall TPR will be Non-CR/Non-PD if no target lesions were present at screening.",
    locations = cells_body(columns = `Overall PCWG TPR`, rows = 12)  # Correct column name
  )
```



#### Derive Combined overall response by Investigator (`OVRLRESC`)  Records  referenced from above table.


```{r, eval=TRUE, include=TRUE, message=FALSE}

adrs <- derive_param_computed(
  dataset = adrs,
  by_vars = exprs(USUBJID,VISIT,ADT,ADTF,AVISIT,AVISITN),
  parameters = c("SFTSRESP", "BONERESP"),
  set_values_to = exprs(
    # Deriving AVALC (Character tumor response)
    AVALC = case_when(
      AVALC.SFTSRESP == "PD" | AVALC.BONERESP == "PD" ~ "PD",            # Progressive Disease
      AVALC.SFTSRESP == "CR" & AVALC.BONERESP == "NED" ~ "CR",           # Complete Response
      AVALC.SFTSRESP == "PR" & AVALC.BONERESP %in% c("NON-PD", "PDu") ~ "PR", # Partial Response
      AVALC.SFTSRESP == "SD" & AVALC.BONERESP %in% c("NON-PD", "PDu", "NED") ~ "SD", # Stable Disease
      AVALC.SFTSRESP == "NE" & AVALC.BONERESP == "NE" ~ "NE",            # Not Evaluable
      TRUE ~ NA_character_                            # Default for missing/unmatched values
    ),
    PARAMCD = "OVRLRESC",
    PARAM = "Combined Overall Tumor Response by Investigator-Derived",
    PARAMN = 5,
    PARCAT1 = "PCWG3 and RECIST 1.1 Derived"
  )
)

  
``` 


```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
   display_vars = exprs(USUBJID,PARAM,PARAMCD,PARCAT1,AVALC,AVISIT,ADT)
)
```


## Derive `AVAL` (Numeric tumor response from AVALC values)

```{r}
adrs <- adrs %>%
  mutate(
    
    AVAL = case_when(
      AVALC == "NED" ~ 0,         # No Evidence of Disease
      AVALC == "CR" ~ 1,          # Complete Response
      AVALC == "PR" ~ 2,          # Partial Response
      AVALC == "SD" ~ 3,          # Stable Disease
      AVALC == "PD" ~ 4,          # Progressive Disease
      AVALC == "PDu" ~ 5,         # Progressive Disease Unconfirmed
      AVALC == "NE" ~ 6,          # Not Evaluable
      AVALC == "NON-PD" ~ 7,      # Non-Progressive Disease (optional if needed)
      TRUE ~ NA_real_             # Default for unexpected/missing AVALC values
    )
  )
```

```{r, echo=FALSE}
dataset_vignette(
  adrs %>%
    arrange(!!!get_admiral_option("subject_keys"), PARAMN,),
  display_vars = exprs(USUBJID,PARCAT1,PARAMCD, PARAM,PARAMN,AVISIT,AVISITN,ADT,AVALC,AVAL)
)
```


## Bone Lesion Confirmation Guidance (`The 2+2 flare Rule in PCWG3`)

The "2+2 rule" is a critical concept used to assess disease progression in metastatic prostate cancer, particularly when evaluating bone scans. It helps differentiate true progression from a temporary treatment-related flare reaction.

#### Under the 2+2 rule:

If 2 or more new lesions appear on a bone scan after starting treatment, this might suggest disease progression—but these lesions could also result from a flare reaction, a temporary effect caused by the treatment.

To confirm progression, a follow-up scan must show 2 additional new lesions. Only then is progression definitively confirmed.

By requiring confirmation through a second scan, the 2+2 rule avoids misinterpretation of temporary changes and ensures doctors make accurate decisions about continuing or modifying treatment.


```{r, eval=TRUE, include=TRUE, message=FALSE}

# Define events for Unconfirmed Best Overall Response (UBOR)
bor_cr <- event(
  description = "Complete Response (CR) for Best Overall Response",
  dataset_name = "adrs",  
  condition = AVALC == "CR", 
  set_values_to = exprs(AVALC = "CR")
)

bor_pr <- event(
  description = "Partial Response (PR) for Best Overall Response",
  dataset_name = "adrs", 
  condition = AVALC == "PR",
  set_values_to = exprs(AVALC = "PR")
)

bor_sd <- event(
  description = "Stable Disease (SD) for Best Overall Response",
  dataset_name = "adrs",
  condition = AVALC == "SD",
  set_values_to = exprs(AVALC = "SD")
)

bor_pd <- event(
  description = "Progressive Disease (PD) for Best Overall Response",
  dataset_name = "adrs",
  condition = AVALC == "PD",
  set_values_to = exprs(AVALC = "PD")
)

bor_ne <- event(
  description = "Not Evaluable (NE) for Best Overall Response",
  dataset_name = "adrs",
  condition = AVALC == "NE",
  set_values_to = exprs(AVALC = "NE")
)



```
#Derive Best Overall Response (BOR)

Use the defined events to derive BOR based on the first occurrence in the adrs dataset, 
prioritizing responses hierarchically (CR > PR > SD > PD > NE).In this part of the vignette, we will derive Best Overall Response based on combined response (PARAMCD = "OVRLRESC") as Derived above.


```{r, eval=TRUE, include=TRUE, message=FALSE} 

# Derive BOR 
adrs <- adrs %>%
  derive_extreme_event(
    by_vars = exprs(USUBJID),                             
    events = list(bor_cr, bor_pr, bor_sd, bor_pd, bor_ne), 
    source_datasets = list(adrs = adrs %>% filter(PARAMCD == "OVRLRESC")), 
    order = exprs(AVISITN, ADT),                        
    tmp_event_nr_var = event_nr,                        
    mode = "first",                               
    set_values_to = exprs(
      PARAMCD = "BOR",                              
      PARAM = "Best Overall Response",               
      PARAMN = 10                        
    )
  )
```


```{r, echo=FALSE}
dataset_vignette(
  adrs%>%
  filter(PARAMCD== "BOR"),
  display_vars = exprs(USUBJID,PARAM,PARAMCD,AVISIT, AVISITN,ADT,AVALC,AVAL)
)
```

#Derive Confirmed BOR (CBOR) of Interest, i.e CR and PR

For Confirmation ,both RECIST 1.1 and PCWG3 Guidelines Suggests the use of a 28-day confirmation period for responses l
ike Complete Response (CR) or Partial Response (PR).

```{r, eval=TRUE, include=TRUE, message=FALSE}
cbor_cr <- event_joined(
  description = "Confirmed Complete Response (CR)",
  dataset_name = "adrs",
  join_vars = exprs(AVALC, ADT),
  join_type = "after",
  first_cond_upper = AVALC.join == "CR" & ADT.join >= ADT + 28,
  condition = AVALC == "CR" & all(AVALC.join == "CR"),
  set_values_to = exprs(AVALC = "CR")
)

cbor_pr <- event_joined(
  description = "Confirmed Partial Response (PR)",
  dataset_name = "adrs",
  join_vars = exprs(AVALC, ADT),
  join_type = "after",
  first_cond_upper = AVALC.join %in% c("CR", "PR") & ADT.join >= ADT + 28,
  condition = AVALC == "PR" & all(AVALC.join %in% c("CR", "PR")),
  set_values_to = exprs(AVALC = "PR")
)

```  


```{r, eval=TRUE, include=TRUE, message=FALSE}
adrs <- adrs %>%
  derive_extreme_event(
    by_vars = exprs(USUBJID),                 
    events = list(cbor_cr, cbor_pr),         
    source_datasets = list(adrs = adrs %>% filter(PARAMCD == "OVRLRESC")),
    tmp_event_nr_var = event_nr,             
    order = exprs(event_nr, ADT),            
    mode = "first",                     
    set_values_to = exprs(
      PARAMCD = "CBOR",                         
      PARAM = "Confirmed Best Overall Response by Investigator", 
      PARAMN = 11             
    )
  )
```

```{r, echo=FALSE}
dataset_vignette(
  adrs%>%
    filter(PARAMCD== "CBOR"),
  display_vars = exprs(USUBJID,PARAM,PARAMCD,AVISIT,AVISITN,ADT,AVALC,AVAL)
)
```

# Other Endpoints {#other}

For examples on the additional endpoints, please see [Creating ADRS (Including Non-standard Endpoints)](adrs.html).
